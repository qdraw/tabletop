<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <h1 id="getLatestbyname"></h1>
    <h2> activiteit van de laatste 8 uur: </h2>
<div id="data"></div>
<div>Deze pagina wordt niet automatisch geupdate</div>

<script type="text/javascript" src="js/vendor/d3.v4.min.js"></script>
<script type="text/javascript">
function loadJSON(path, success, error)	{
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function()
		{
			if (xhr.readyState === XMLHttpRequest.DONE) {
				if (xhr.status === 200) {
					if (success)
						success(JSON.parse(xhr.responseText));
				} else {
					if (error) {
                        console.log("err");
						error(xhr);
                        }
				}
			}
		};
		xhr.open("GET", path, true);
		xhr.send();
	}

	function loadDATA() {
        var url = "api/getRecentByName?name=tafelvoetbal";
        // var url = "getRecentByName_name_tafelvoetbal.json?" + Date.now();
		loadJSON(url,
				 function(data) {
                     listOfData = parseData(data)
                     barChart(listOfData,"#data")
                 },
                function(xhr) { console.error(xhr); }
       )
       url = "api/getLatestbyname?name=tafelvoetbal"
       loadJSON(url,
                function(data) {
                    var d = new Date(data);
                    console.log(d);
                    document.querySelector('#getLatestbyname').innerHTML = "Laatste activiteit (tijd is in utc)"  + data;
                },
               function(xhr) { console.error(xhr); }
      )
   }
   loadDATA();

   function parseData(data) {

        var now = new Date();
        var utc_timestamp_unix = Date.UTC(now.getUTCFullYear(),now.getUTCMonth(), now.getUTCDate() ,
             now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds(), now.getUTCMilliseconds())/1000;
        var Offset = now.getTimezoneOffset() * 60;

        // Nasty hack Safari is using utc by default
        var isSafari = navigator.vendor && navigator.vendor.indexOf('Apple') > -1 &&
                navigator.userAgent && !navigator.userAgent.match('CriOS');
        console.log(isSafari);
        if (isSafari) {
            Offset = 0;
        }
        // end nasty hack

       var eighthoursago_unix = Math.floor(utc_timestamp_unix - 28800); // in seconds
       var steps = 60; // in seconds

       console.log("utc_timestamp_unix");
       console.log(utc_timestamp_unix);
       console.log("eighthoursago_unix");
       console.log(eighthoursago_unix);

       function checkForData(start_search_unix) {
           for (var i = 0; i < data.length; i++) {

               var d = new Date(data[i].dateTime + "+00:00");

                d_unixtimestamp = Math.floor(d/1000);
                if (d_unixtimestamp >= start_search_unix && d_unixtimestamp <= start_search_unix+steps) {
                    return i
                }
           }
           return -1
       }
       var listOfData = [];


       for (var i = eighthoursago_unix; i < utc_timestamp_unix-1; i = i + steps) {
           var arrrayInt  = -1;
           arrrayInt = checkForData(i);
           var dateI = new Date(i*1000);

           if (arrrayInt >= 0) {
               listOfData.push({
                    "label": dateI,
                    "value":data[arrrayInt].weight + 1
                })
           }
           else {

               listOfData.push({
                    "label": dateI,
                    "value": 0
                })
           }
       }
       console.log(listOfData);
       return listOfData;
   }


   function barChart(data,element) {
   		// set the dimensions and margins of the graph
   		var margin = {top: 10, right: 0, bottom: 20, left: 30},
   		width = 800 + (margin.right - margin.left),
   		height = 300;

   		// set the ranges
   		var x = d3.scaleBand()
   			.range([0, width])
   			.padding(0.1);
   		var y = d3.scaleLinear()
   			.range([height, 0]);

   		// append the svg object to the body of the page
   		// append a 'group' element to 'svg'
   		// moves the 'group' element to the top left margin
   		var svg = d3.select(element).append("svg")
   				.attr("preserveAspectRatio", "xMinYMin meet")
   				.attr("viewBox", "0 0 " + (width + margin.left + margin.right) + " " + height)

   			.attr("width", width + margin.left + margin.right)
   			.attr("class","bar")
   			.attr("height", height + margin.top + margin.bottom)
   			.attr("fill", "#000")
   			.append("g")
   			.attr("transform",
   			"translate(" + margin.left + "," + margin.top + ")");

   		// Scale the range of the data in the domains
   		x.domain(data.map(function(d) { return d.label; }));
   		y.domain([0, d3.max(data, function(d) { return d.value; })]);

   		// append the rectangles for the bar chart
   		svg.selectAll(".bar")
   			.data(data)
   			.enter().append("rect")
   			.attr("class", "bar")
   			.attr("x", function(d) { return x(d.label); })
   			.attr("width", x.bandwidth())
   			.attr("y", function(d) { return y(d.value); })
   			.attr("height", function(d) { return height - y(d.value); });

   		// add the x Axis
   		svg.append("g")
   			.attr("transform", "translate(0," + height + ")")
   			.attr("stroke", "#fff")
   			.call(d3.axisBottom(x));

   		// add the y Axis
   		svg.append("g")
   			.attr("stroke", "#000")
   			.call(d3.axisLeft(y));
   	}
</script>

    <!-- <script type="text/javascript">
        var xmlhttp = new XMLHttpRequest();
        // var url = "api/getRecentByName?name=tafelvoetbal";
        var url = "getRecentByName_name_tafelvoetbal.json";

        xmlhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var myArr = JSON.parse(this.responseText);
                console.log(myArr);
            }
        };

        xmlhttp.open("GET", url, true);
        xmlhttp.send();
    </script> -->


</body>
</html>
